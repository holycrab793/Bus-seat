<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>45ì¸ìŠ¹ ë²„ìŠ¤ ì¢Œì„ ë°°ì¹˜ë„</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:10px;
    }
    .container{
      max-width:480px; margin:0 auto; background:#fff; border-radius:20px;
      padding:15px; box-shadow:0 20px 60px rgba(0,0,0,0.3);
    }
    h1{ text-align:center; color:#333; margin-bottom:10px; font-size:24px; }
    .subtitle{ text-align:center; color:#666; margin-bottom:20px; font-size:14px; }

    .controls{
      display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:20px;
    }
    button{
      padding:12px; border:none; border-radius:10px; font-size:13px; font-weight:700;
      cursor:pointer; transition:all .3s;
    }
    .save-btn{ background:#10b981; color:#fff; }
    .save-btn:hover{ background:#059669; transform:translateY(-2px); }
    .clear-btn{ background:#ef4444; color:#fff; }
    .clear-btn:hover{ background:#dc2626; transform:translateY(-2px); }
    .share-btn{ background:#3b82f6; color:#fff; }
    .share-btn:hover{ background:#2563eb; transform:translateY(-2px); }
    .download-btn{ background:#8b5cf6; color:#fff; }
    .download-btn:hover{ background:#7c3aed; transform:translateY(-2px); }

    /* âœ… ìº¡ì²˜ ì˜ì—­(ì œëª©/ë²„íŠ¼ ì œì™¸) + ì¹´í†¡/í”Œë«í¼ í¬ë¡­ ë°©ì§€ìš© ì„¸ì´í”„ ë§ˆì§„ */
    #capture-area{
      background:#ffffff;
      border-radius:16px;
      padding:16px;            /* ìƒë‹¨ ì˜ë¦¼ ë°©ì§€ + ë¯¸ë¦¬ë³´ê¸° ì•ˆì •í™” */
      overflow:hidden;
    }

    /* âœ… ì´ë¯¸ì§€ ìƒë‹¨ ìš”ì•½ í—¤ë”(ì…ì„ ëª‡ ëª… í¬ê²Œ) */
    .capture-header{
      background:#111827;
      color:#fff;
      border-radius:14px;
      padding:12px 12px;
      margin-bottom:12px;
    }
    .capture-title{
      font-weight:900;
      font-size:15px;
      letter-spacing:-0.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .capture-title .date{
      font-weight:700;
      font-size:12px;
      opacity:.85;
      white-space:nowrap;
    }
    .capture-metrics{
      margin-top:8px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:8px;
    }
    .metric{
      background:rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:12px;
      padding:10px 8px;
      text-align:center;
    }
    .metric .label{
      font-size:11px;
      opacity:.85;
      font-weight:800;
    }
    .metric .value{
      margin-top:2px;
      font-size:18px;          /* ìˆ«ì í¬ê²Œ */
      font-weight:950;
      letter-spacing:-0.5px;
    }
    .metric.standing .value{
      font-size:20px;          /* ì…ì„ ë” í¬ê²Œ */
    }

    .bus{
      background:#f8f9fa; border-radius:15px; padding:15px 10px; position:relative;
    }
    .driver-row{
      display:flex; gap:6px; margin-bottom:15px; align-items:center;
    }
    .driver-seat{
      flex:1; background:#1f2937; color:#fff; padding:12px; border-radius:10px;
      text-align:center; font-weight:800; font-size:14px;
    }
    .door{
      flex:1; background:#f59e0b; color:#fff; padding:12px; border-radius:10px;
      text-align:center; font-weight:800; font-size:14px;
    }
    .row{ display:flex; gap:6px; margin-bottom:10px; align-items:center; }
    .row-number{
      width:25px; text-align:center; font-weight:800; color:#6b7280; font-size:13px; flex-shrink:0;
    }
    .seats-left,.seats-right{ display:flex; gap:6px; flex:1; }
    .aisle{ width:15px; text-align:center; color:#d1d5db; font-size:11px; }

    .seat{
      flex:1; background:#fff; border:2px solid #e5e7eb; border-radius:8px;
      padding:18px 2px; text-align:center; transition:all .3s; cursor:pointer;
      position:relative; min-width:55px; min-height:50px;
      display:flex; align-items:center; justify-content:center;
    }
    .seat:hover{
      border-color:#667eea; transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(102,126,234,.2);
    }
    .seat input{
      width:100%; border:none; background:transparent; text-align:center;
      font-size:16px; outline:none; font-family:inherit; font-weight:800;
      padding:0; letter-spacing:-0.5px;
    }
    .seat.filled{
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff; border-color:#667eea;
    }
    .seat.filled input{ color:#fff; }
    .seat-number{
      position:absolute; top:2px; left:4px; font-size:9px; color:#9ca3af;
    }
    .seat.filled .seat-number{ color:rgba(255,255,255,.75); }

    .last-row{ display:flex; gap:8px; margin-top:20px; }
    .last-row .seat{ flex:1; }

    .status{
      text-align:center; margin-top:12px; padding:10px;
      background:#f0fdf4; border-radius:12px; font-size:14px; color:#166534;
      font-weight:800;
    }

    /* âœ… ë³µë„(ì…ì„) ì˜ì—­ */
    .standing{
      margin-top:12px; background:#f8f9fa; border-radius:12px; padding:12px 10px;
    }
    .standing-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px;
    }
    .standing-title{ font-weight:900; color:#374151; font-size:14px; }
    .standing-actions{ display:flex; gap:6px; }
    .mini-btn{
      padding:8px 10px; border-radius:10px; font-size:12px; font-weight:900;
      background:#e5e7eb; color:#111827;
    }
    .mini-btn:hover{ transform:translateY(-1px); }
    .standing-list{
      display:grid; grid-template-columns:1fr 1fr; gap:8px;
    }
    .standing-item{
      background:#fff; border:2px solid #e5e7eb; border-radius:10px;
      padding:8px 10px; display:flex; align-items:center; gap:8px;
    }
    .standing-badge{
      min-width:26px; height:26px; border-radius:8px;
      background:#111827; color:#fff; display:flex; align-items:center; justify-content:center;
      font-weight:950; font-size:12px;
    }
    .standing-item input{
      width:100%; border:none; outline:none; font-size:14px; font-weight:800; background:transparent;
    }
    .standing-item.filled{
      border-color:#667eea; box-shadow:0 4px 12px rgba(102,126,234,.15);
    }

    .toast{
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:#1f2937; color:#fff; padding:12px 24px; border-radius:10px;
      box-shadow:0 10px 40px rgba(0,0,0,.3);
      z-index:1000; opacity:0; transition:opacity .3s;
      max-width:92vw; text-align:center; line-height:1.35; white-space:pre-line;
    }
    .toast.show{ opacity:1; }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸšŒ 45ì¸ìŠ¹ ë²„ìŠ¤ ì¢Œì„ë°°ì¹˜</h1>
    <p class="subtitle">ì¢Œì„ì„ í´ë¦­í•˜ì—¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</p>

    <div class="controls">
      <button class="save-btn" onclick="saveAll()">ğŸ’¾ ì €ì¥</button>
      <button class="clear-btn" onclick="clearAll()">ğŸ—‘ï¸ ì‚­ì œ</button>
      <button class="share-btn" onclick="shareSeatingImage()">ğŸ”— ê³µìœ </button>
      <button class="download-btn" onclick="shareSeatingImage()">ğŸ“· ì‚¬ì§„ì €ì¥</button>
    </div>

    <!-- âœ… ìº¡ì²˜ ì˜ì—­: ì´ ì•ˆë§Œ ì´ë¯¸ì§€ë¡œ ì €ì¥/ê³µìœ ë¨ -->
    <div id="capture-area">
      <!-- âœ… ì´ë¯¸ì§€ ìƒë‹¨ ìš”ì•½ -->
      <div class="capture-header">
        <div class="capture-title">
          <div>ğŸšŒ ì¢Œì„ë°°ì¹˜ ìš”ì•½</div>
          <div class="date" id="capture-date"></div>
        </div>
        <div class="capture-metrics">
          <div class="metric">
            <div class="label">ì¢Œì„</div>
            <div class="value" id="metric-seat">0</div>
          </div>
          <div class="metric standing">
            <div class="label">ë³µë„(ì…ì„)</div>
            <div class="value" id="metric-standing">0</div>
          </div>
          <div class="metric">
            <div class="label">ì´ì›</div>
            <div class="value" id="metric-total">0</div>
          </div>
        </div>
      </div>

      <div class="bus">
        <div class="driver-row">
          <div class="row-number"></div>
          <div class="driver-seat">ğŸš— ìš´ì „ì„</div>
          <div class="aisle"></div>
          <div class="door">ğŸšª ë¬¸</div>
        </div>
        <div id="bus-seats"></div>
      </div>

      <div class="status" id="status">
        íƒ‘ìŠ¹ì¸ì›: <strong>0</strong>ëª…
      </div>

      <div class="standing" id="standing">
        <div class="standing-header">
          <div class="standing-title">ğŸ§ ë³µë„(ì…ì„) íƒ‘ìŠ¹ì</div>
          <div class="standing-actions">
            <button class="mini-btn" type="button" onclick="addStanding()">+ ì¶”ê°€</button>
            <button class="mini-btn" type="button" onclick="removeStanding()">- ì‚­ì œ</button>
          </div>
        </div>
        <div class="standing-list" id="standing-list"></div>
      </div>
    </div>
    <!-- /ìº¡ì²˜ ì˜ì—­ -->
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const STORAGE_KEY = 'bus-seating-v3';
    let seatData = {};       // { seatNumber: name }
    let standingData = [];   // [name...]
    let seatCounter = 1;

    const DEFAULT_STANDING_SLOTS = 6;
    const MAX_STANDING_SLOTS = 20;

    function init() {
      buildSeats();
      buildStanding(DEFAULT_STANDING_SLOTS);
      loadAll();
      updateStatus();
      setCaptureDate();
    }

    function setCaptureDate(){
      const el = document.getElementById('capture-date');
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      el.textContent = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function buildSeats() {
      const busSeats = document.getElementById('bus-seats');
      busSeats.innerHTML = '';
      seatCounter = 1;

      for (let row = 1; row <= 10; row++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row';

        const rowNum = document.createElement('div');
        rowNum.className = 'row-number';
        rowNum.textContent = row;
        rowDiv.appendChild(rowNum);

        const seatsLeft = document.createElement('div');
        seatsLeft.className = 'seats-left';
        for (let i = 0; i < 2; i++) seatsLeft.appendChild(createSeat(seatCounter++));
        rowDiv.appendChild(seatsLeft);

        const aisle = document.createElement('div');
        aisle.className = 'aisle';
        aisle.textContent = 'ğŸš¶';
        rowDiv.appendChild(aisle);

        const seatsRight = document.createElement('div');
        seatsRight.className = 'seats-right';
        for (let i = 0; i < 2; i++) seatsRight.appendChild(createSeat(seatCounter++));
        rowDiv.appendChild(seatsRight);

        busSeats.appendChild(rowDiv);
      }

      const lastRowContainer = document.createElement('div');
      lastRowContainer.style.marginTop = '20px';

      const lastRowNum = document.createElement('div');
      lastRowNum.className = 'row-number';
      lastRowNum.textContent = '11';
      lastRowNum.style.marginBottom = '8px';
      lastRowNum.style.textAlign = 'center';
      lastRowContainer.appendChild(lastRowNum);

      const lastRow = document.createElement('div');
      lastRow.className = 'last-row';
      for (let i = 0; i < 5; i++) lastRow.appendChild(createSeat(seatCounter++));
      lastRowContainer.appendChild(lastRow);

      busSeats.appendChild(lastRowContainer);
    }

    function createSeat(number) {
      const seat = document.createElement('div');
      seat.className = 'seat';
      seat.dataset.seat = number;

      const seatNum = document.createElement('div');
      seatNum.className = 'seat-number';
      seatNum.textContent = number;
      seat.appendChild(seatNum);

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'ì¢Œì„ ' + number;
      input.dataset.seat = number;

      input.addEventListener('input', (e) => {
        const value = e.target.value.trim();
        if (value) {
          seat.classList.add('filled');
          seatData[number] = value;
        } else {
          seat.classList.remove('filled');
          delete seatData[number];
        }
        updateStatus();
      });

      seat.appendChild(input);
      return seat;
    }

    function buildStanding(count) {
      const list = document.getElementById('standing-list');
      list.innerHTML = '';

      const next = Array.from({ length: count }, (_, i) => (standingData[i] || ''));
      standingData = next;

      for (let i = 0; i < count; i++) {
        list.appendChild(createStandingItem(i));
      }
    }

    function createStandingItem(index) {
      const item = document.createElement('div');
      item.className = 'standing-item';
      item.dataset.standing = index;

      const badge = document.createElement('div');
      badge.className = 'standing-badge';
      badge.textContent = index + 1;
      item.appendChild(badge);

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'ì´ë¦„';
      input.dataset.standing = index;

      input.addEventListener('input', (e) => {
        const v = e.target.value.trim();
        standingData[index] = v;
        if (v) item.classList.add('filled');
        else item.classList.remove('filled');
        updateStatus();
      });

      item.appendChild(input);
      return item;
    }

    function addStanding() {
      const current = standingData.length;
      if (current >= MAX_STANDING_SLOTS) {
        showToast(`âš ï¸ ë³µë„ íƒ‘ìŠ¹ìëŠ” ìµœëŒ€ ${MAX_STANDING_SLOTS}ëª…ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        return;
      }
      buildStanding(current + 1);
      updateStatus();
      showToast('â• ë³µë„ ì¹¸ ì¶”ê°€');
    }

    function removeStanding() {
      const current = standingData.length;
      if (current <= 1) { showToast('âš ï¸ ë” ì´ìƒ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

      const lastVal = (standingData[current - 1] || '').trim();
      if (lastVal && !confirm('ë§ˆì§€ë§‰ ë³µë„ ì¹¸ì˜ ì´ë¦„ì´ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      buildStanding(current - 1);
      updateStatus();
      showToast('â– ë³µë„ ì¹¸ ì‚­ì œ');
    }

    function saveAll() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          seatData,
          standingData,
          standingSlots: standingData.length
        }));
        showToast('ğŸ’¾ ì €ì¥ ì™„ë£Œ');
      } catch (e) {
        console.error(e);
        showToast('âš ï¸ ì €ì¥ ì‹¤íŒ¨');
      }
    }

    function loadAll() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;

        const payload = JSON.parse(raw) || {};
        seatData = payload.seatData || {};
        standingData = Array.isArray(payload.standingData) ? payload.standingData : [];
        const slots = payload.standingSlots || Math.max(DEFAULT_STANDING_SLOTS, standingData.length || 0);

        Object.keys(seatData).forEach(seatNum => {
          const input = document.querySelector(`input[data-seat="${seatNum}"]`);
          if (input) {
            input.value = seatData[seatNum];
            input.parentElement.classList.add('filled');
          }
        });

        buildStanding(Math.min(Math.max(1, slots), MAX_STANDING_SLOTS));
        standingData.forEach((name, i) => {
          const input = document.querySelector(`input[data-standing="${i}"]`);
          const item = document.querySelector(`.standing-item[data-standing="${i}"]`);
          if (input) input.value = name || '';
          if (item && (name || '').trim()) item.classList.add('filled');
        });
      } catch (e) {
        console.error(e);
      }
    }

    function clearAll() {
      if (!confirm('ì •ë§ë¡œ ëª¨ë“  ì¢Œì„/ë³µë„ íƒ‘ìŠ¹ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      seatData = {};
      standingData = Array.from({ length: DEFAULT_STANDING_SLOTS }, () => '');

      document.querySelectorAll('.seat input').forEach(input => {
        input.value = '';
        input.parentElement.classList.remove('filled');
      });

      buildStanding(DEFAULT_STANDING_SLOTS);
      try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}

      updateStatus();
      showToast('ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ ì™„ë£Œ');
    }

    function updateStatus() {
      const seatCount = Object.keys(seatData).length;
      const standingCount = standingData.filter(v => (v || '').trim()).length;
      const total = seatCount + standingCount;

      document.getElementById('status').innerHTML =
        `íƒ‘ìŠ¹ì¸ì›: <strong>${total}</strong>ëª… (ì¢Œì„ <strong>${seatCount}</strong>/45, ë³µë„ <strong>${standingCount}</strong>)`;

      // âœ… ì´ë¯¸ì§€ ìƒë‹¨ ìš”ì•½ ê°±ì‹ 
      document.getElementById('metric-seat').textContent = seatCount;
      document.getElementById('metric-standing').textContent = standingCount;
      document.getElementById('metric-total').textContent = total;
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), 2600);
    }

    function detectEnv() {
      const ua = navigator.userAgent || '';
      return {
        isIOS: /iPhone|iPad|iPod/i.test(ua),
        isAndroid: /Android/i.test(ua),
        isKakaoInApp: /KAKAOTALK/i.test(ua)
      };
    }

    // âœ… ìº¡ì²˜ ëŒ€ìƒ: #capture-area (ì œëª©/ë²„íŠ¼ ì œì™¸)
    async function renderToPngFile() {
      const container = document.getElementById('capture-area');

      const canvas = await html2canvas(container, {
        backgroundColor: '#ffffff',
        scale: 2,
        logging: false,
        scrollY: -window.scrollY,     // iOS/ëª¨ë°”ì¼ ìƒë‹¨ í¬ë¡­ ë³´ì •
        scrollX: -window.scrollX
      });

      const blob = await new Promise((resolve, reject) => {
        canvas.toBlob(b => (b ? resolve(b) : reject(new Error('toBlob failed'))), 'image/png');
      });

      const date = new Date().toISOString().slice(0, 10);
      return new File([blob], `ë²„ìŠ¤ì¢Œì„ë°°ì¹˜_${date}.png`, { type: 'image/png' });
    }

    // âœ… ì¹´í†¡/ë©”ì‹ ì € í…ìŠ¤íŠ¸ ë¶™ëŠ” ë¬¸ì œ ë°©ì§€: title/text ì ˆëŒ€ ë„£ì§€ ì•ŠìŒ (filesë§Œ)
    async function shareSeatingImage() {
      const { isIOS, isAndroid, isKakaoInApp } = detectEnv();

      try {
        showToast('ğŸ“· ì´ë¯¸ì§€ ìƒì„±ì¤‘...');
        setCaptureDate(); // ê³µìœ  ì‹œê° ê°±ì‹ 
        const file = await renderToPngFile();

        const canFileShare = !!(navigator.share && navigator.canShare && navigator.canShare({ files: [file] }));
        if (!canFileShare) {
          showToast(isIOS ? 'âš ï¸ ê³µìœ ê°€ ì•ˆ ë˜ë©´ Safariì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.' : 'âš ï¸ ê³µìœ ê°€ ì•ˆ ë˜ë©´ Chromeì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.');
          return;
        }

        // ğŸ”¥ í•µì‹¬: filesë§Œ ì „ë‹¬
        await navigator.share({ files: [file] });

        if (isKakaoInApp) {
          showToast('âœ… ì¹´í†¡ì—ëŠ” ì‚¬ì§„ë§Œ ì „ì†¡ë©ë‹ˆë‹¤.\nì‚¬ì§„ ì•± ì €ì¥ì€ ê³µìœ  ë©”ë‰´ì—ì„œ â€œì‚¬ì§„ì— ì €ì¥â€ ì„ íƒ');
        } else if (isIOS) {
          showToast('âœ… ê³µìœ  ë©”ë‰´ì—ì„œ â€œì‚¬ì§„ì— ì €ì¥â€ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        } else if (isAndroid) {
          showToast('âœ… ê°¤ëŸ¬ë¦¬/Google í¬í† ë¡œ ì €ì¥ ë˜ëŠ” ì¹´í†¡ ê³µìœ ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        } else {
          showToast('âœ… ê³µìœ  ì™„ë£Œ');
        }
      } catch (e) {
        console.error(e);
        showToast('âš ï¸ ê³µìœ ê°€ ì·¨ì†Œë˜ì—ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ìë™ì €ì¥: ì¢Œì„/ë³µë„ ì…ë ¥ì—ì„œë§Œ ë™ì‘
    let saveTimeout;
    document.addEventListener('input', (e) => {
      const t = e.target;
      if (!(t && t.matches)) return;
      if (!(t.matches('#bus-seats input') || t.matches('#standing-list input'))) return;

      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => saveAll(), 900);
    });

    init();
  </script>
</body>
</html>
